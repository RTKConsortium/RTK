name: Build, test, package

on: [push,pull_request]

concurrency:
  group: '${{ github.workflow }}@${{ github.head_ref || github.run_id }}'
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  cxx-build-workflow:
    uses: InsightSoftwareConsortium/ITKRemoteModuleBuildTestPackageAction/.github/workflows/build-test-cxx.yml@v5.4.4

  python-build-workflow:
    uses: InsightSoftwareConsortium/ITKRemoteModuleBuildTestPackageAction/.github/workflows/build-test-package-python.yml@v5.4.4
    with:
      cmake-options: '-DRTK_BUILD_APPLICATIONS:BOOL=OFF'
      python3-minor-versions: ${{ github.event_name == 'pull_request' && '["11"]' || '["9","10","11"]' }}
      itk-python-package-tag: 'release-5.4'
    secrets:
      pypi_password: ${{ secrets.pypi_password }}

  test-python-wheel:
    needs:
      - python-build-workflow
    runs-on: self-hosted-linux

    steps:
    - uses: actions/checkout@v4

    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        path: wheels

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Test python wheel
      run: |
        # Find wheel for Python 3.11 dynamically
        wheel=$(find wheels -name "*cp311*manylinux_2_28_x86_64.whl" -type f | head -1)

        pip uninstall -y $(pip list |  grep -E '^itk-') || true
        echo "Installing wheel: $wheel"
        pip install $wheel

        pip install pytest matplotlib
        pytest $GITHUB_WORKSPACE/test/*.py -vv -W "ignore:builtin type swig"
